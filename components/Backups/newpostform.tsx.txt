'use client'

import { useState } from 'react'
import { addDoc, collection, serverTimestamp } from 'firebase/firestore'
import { db, auth } from '@/lib/firebase'

interface Props {
  onSuccess?: () => void
}

export default function NewPostForm({ onSuccess }: Props = {}) {
  const [title, setTitle] = useState('')
  const [content, setContent] = useState('')
  const [category, setCategory] = useState('general')
  const [loading, setLoading] = useState(false)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!auth.currentUser) {
      alert('Please log in first')
      return
    }

    setLoading(true)

    try {
      await addDoc(collection(db, 'bbs_posts'), {
        title,
        content,
        category,
        user_id: auth.currentUser.uid,
        user_name: auth.currentUser.displayName || auth.currentUser.email?.split('@')[0],
        likes: 0,
        is_active: true,
        created_at: serverTimestamp(),
      })

      setTitle('')
      setContent('')
      setCategory('general')
      onSuccess?.()
    } catch (error) {
      alert('Error posting. Try again.')
      console.error(error)
    } finally {
      setLoading(false)
    }
  }

  return (
    <form onSubmit={handleSubmit} className="bg-white p-8 rounded-2xl shadow-lg">
      <h2 className="text-2xl font-bold mb-6">Share Something with the Island</h2>
      
      <input
        type="text"
        placeholder="Title"
        value={title}
        onChange={(e) => setTitle(e.target.value)}
        required
        disabled={loading}
        className="w-full p-4 border rounded-lg mb-4"
      />
      
      <textarea
        placeholder="What's happening?"
        value={content}
        onChange={(e) => setContent(e.target.value)}
        required
        rows={5}
        disabled={loading}
        className="w-full p-4 border rounded-lg mb-4"
      />
      
      <select
        value={category}
        onChange={(e) => setCategory(e.target.value)}
        className="w-full p-4 border rounded-lg mb-6"
      >
        <option value="general">General</option>
        <option value="events">Events</option>
        <option value="buy-sell">Buy / Sell</option>
        <option value="help">Need Help / Offering Help</option>
      </select>
      
      <button
        type="submit"
        disabled={loading}
        className="w-full bg-green-700 text-white py-4 rounded-lg text-xl font-bold hover:bg-green-800 disabled:opacity-50"
      >
        {loading ? 'Posting...' : 'Post to Community'}
      </button>
    </form>
  )
}