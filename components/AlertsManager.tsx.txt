// components/AlertsManager.tsx
// v3.1 - Dec 11, 2025 - FIXED: Filter expired alerts, don't show in active view
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useUser } from '@/components/AuthProvider';
import { AlertTriangle, Plus, X, Bell, AlertCircle, Info, Edit2, Archive } from 'lucide-react';
import { AlertSeverity } from '@/lib/types';

interface Alert {
  id: string;
  severity: AlertSeverity;
  title: string;
  message: string;
  issued_by?: string | null;  // UUID of actual creator
  on_behalf_of_name?: string | null;  // Optional "on behalf of"
  on_behalf_of_organization?: string | null;  // Optional organization
  created_at: string;
  expires_at?: string | null;
  active: boolean;  // Match SQL column name
  affected_areas?: string[] | null;
  category?: string | null;
  contact_info?: string | null;
  action_required?: string | null;
  // Join data from users table
  creator_name?: string;  // From users.full_name
  creator_email?: string;  // From users.email
}

export default function AlertsManager() {
  const { user } = useUser();
  const [alerts, setAlerts] = useState<Alert[]>([]);
  const [archivedAlerts, setArchivedAlerts] = useState<Alert[]>([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [editingAlert, setEditingAlert] = useState<Alert | null>(null);
  const [showArchived, setShowArchived] = useState(false);

  const [form, setForm] = useState({
    title: '',
    message: '',
    severity: 'info' as AlertSeverity,
    on_behalf_of_name: '',  // Optional "on behalf of"
    on_behalf_of_organization: '',  // Optional organization
    affected_areas: '',
    category: '',
    contact_info: '',
    action_required: '',
    expiresInHours: 24,
  });

  useEffect(() => {
    fetchAlerts();
  }, []);

  const fetchAlerts = async () => {
    setLoading(true);

    // FIXED: Fetch active alerts with creator info - EXCLUDE EXPIRED
    // Filter: active = true AND (expires_at IS NULL OR expires_at >= NOW())
    const { data: activeData, error: activeError } = await supabase
      .from('alerts')
      .select(`
        *,
        creator:users!issued_by(full_name, email)
      `)
      .eq('active', true)
      .or(`expires_at.is.null,expires_at.gte.${new Date().toISOString()}`)
      .order('created_at', { ascending: false });

    if (!activeError && activeData) {
      // Flatten creator data into alert object
      const formattedActive = activeData.map(alert => ({
        ...alert,
        creator_name: alert.creator?.full_name,
        creator_email: alert.creator?.email,
      }));
      
      const sorted = formattedActive.sort((a, b) => {
        const priority = { emergency: 1, warning: 2, advisory: 3, info: 4 };
        return priority[a.severity as AlertSeverity] - priority[b.severity as AlertSeverity];
      });
      setAlerts(sorted);
    }

    // Fetch archived alerts with creator info
    const { data: archivedData, error: archivedError } = await supabase
      .from('alerts')
      .select(`
        *,
        creator:users!issued_by(full_name, email)
      `)
      .eq('active', false)
      .order('created_at', { ascending: false })
      .limit(50);

    if (!archivedError && archivedData) {
      const formattedArchived = archivedData.map(alert => ({
        ...alert,
        creator_name: alert.creator?.full_name,
        creator_email: alert.creator?.email,
      }));
      setArchivedAlerts(formattedArchived);
    }

    setLoading(false);
  };

  const canManageAlerts = user?.can_issue_alerts || user?.is_super_admin || false;

  const canEditAlert = (alert: Alert) => {
    if (!user) return false;
    // Super admin can edit anything, or creator can edit their own
    return user.is_super_admin || alert.issued_by === user.id;
  };

  const openEditForm = (alert: Alert) => {
    setEditingAlert(alert);
    setForm({
      title: alert.title,
      message: alert.message,
      severity: alert.severity,
      on_behalf_of_name: alert.on_behalf_of_name || '',
      on_behalf_of_organization: alert.on_behalf_of_organization || '',
      affected_areas: alert.affected_areas?.join(', ') || '',
      category: alert.category || '',
      contact_info: alert.contact_info || '',
      action_required: alert.action_required || '',
      expiresInHours: 24,
    });
    setShowForm(true);
  };

  const openNewForm = () => {
    setEditingAlert(null);
    setForm({
      title: '',
      message: '',
      severity: 'info' as AlertSeverity,
      on_behalf_of_name: '',
      on_behalf_of_organization: '',
      affected_areas: '',
      category: '',
      contact_info: '',
      action_required: '',
      expiresInHours: 24,
    });
    setShowForm(true);
  };

  const createOrUpdate = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form.title.trim() || !form.message.trim()) {
      alert('Title and message required');
      return;
    }

    const areasArray = form.affected_areas
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);

    const payload = {
      title: form.title.trim(),
      message: form.message.trim(),
      severity: form.severity,
      on_behalf_of_name: form.on_behalf_of_name.trim() || null,
      on_behalf_of_organization: form.on_behalf_of_organization.trim() || null,
      affected_areas: areasArray.length > 0 ? areasArray : null,
      category: form.category.trim() || null,
      contact_info: form.contact_info.trim() || null,
      action_required: form.action_required.trim() || null,
      expires_at: new Date(Date.now() + form.expiresInHours * 60 * 60 * 1000).toISOString(),
      active: true,
    };

    if (editingAlert) {
      // UPDATE existing alert
      const { error } = await supabase
        .from('alerts')
        .update(payload)
        .eq('id', editingAlert.id);

      if (error) {
        alert('Error updating alert: ' + error.message);
      } else {
        alert('Alert updated successfully!');
        setShowForm(false);
        setEditingAlert(null);
        fetchAlerts();
      }
    } else {
      // CREATE new alert - automatically set issued_by to current user
      const { error } = await supabase
        .from('alerts')
        .insert({
          ...payload,
          issued_by: user?.id,  // Automatically set to current user
        });

      if (error) {
        alert('Error creating alert: ' + error.message);
      } else {
        alert('Alert created successfully!');
        setShowForm(false);
        fetchAlerts();
      }
    }
  };

  const archiveAlert = async (alertId: string) => {
    if (!confirm('Archive this alert? It will still be viewable in the archive.')) return;

    const { error } = await supabase
      .from('alerts')
      .update({ active: false })
      .eq('id', alertId);

    if (error) {
      alert('Error archiving: ' + error.message);
    } else {
      fetchAlerts();
    }
  };

  const restoreAlert = async (alertId: string) => {
    if (!confirm('Restore this alert to active status?')) return;

    const { error } = await supabase
      .from('alerts')
      .update({ active: true })
      .eq('id', alertId);

    if (error) {
      alert('Error restoring: ' + error.message);
    } else {
      fetchAlerts();
    }
  };

  const renderAlert = (alert: Alert, isArchived: boolean) => {
    const severityColors = {
      emergency: 'bg-red-50 border-red-300',
      warning: 'bg-orange-50 border-orange-300',
      advisory: 'bg-yellow-50 border-yellow-300',
      info: 'bg-blue-50 border-blue-300',
    };

    const severityIcons = {
      emergency: <AlertTriangle className="w-8 h-8 text-red-600" />,
      warning: <AlertCircle className="w-8 h-8 text-orange-600" />,
      advisory: <Bell className="w-8 h-8 text-yellow-600" />,
      info: <Info className="w-8 h-8 text-blue-600" />,
    };

    const isExpired = alert.expires_at && new Date(alert.expires_at) < new Date();

    return (
      <div
        key={alert.id}
        className={`rounded-xl border-2 p-6 shadow-md transition-all hover:shadow-lg ${
          isArchived || isExpired ? 'opacity-75' : ''
        } ${severityColors[alert.severity]}`}
      >
        <div className="flex items-start justify-between gap-4">
          <div className="flex gap-4 flex-1">
            <div className="flex-shrink-0">
              {severityIcons[alert.severity]}
            </div>
            <div className="flex-1">
              <div className="flex items-start justify-between gap-4 mb-2">
                <h3 className="text-2xl font-bold text-gray-900">
                  {alert.title}
                  {isExpired && !isArchived && (
                    <span className="ml-2 text-sm text-gray-500">(Expired)</span>
                  )}
                </h3>
              </div>
              <p className="text-gray-700 text-lg mb-3 whitespace-pre-wrap">{alert.message}</p>

              {/* Affected areas */}
              {alert.affected_areas && alert.affected_areas.length > 0 && (
                <div className="mb-2">
                  <span className="text-sm font-semibold text-gray-700">Affected Areas: </span>
                  <span className="text-sm text-gray-600">{alert.affected_areas.join(', ')}</span>
                </div>
              )}

              {/* Category badge */}
              {alert.category && (
                <span className="inline-block px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm font-medium mb-2">
                  {alert.category}
                </span>
              )}

              {/* Action required */}
              {alert.action_required && (
                <div className="bg-white/50 border-l-4 border-gray-400 pl-4 py-2 mb-2">
                  <p className="text-sm font-semibold text-gray-700">Action Required:</p>
                  <p className="text-sm text-gray-600">{alert.action_required}</p>
                </div>
              )}

              {/* Contact info */}
              {alert.contact_info && (
                <div className="mb-2">
                  <span className="text-sm font-semibold text-gray-700">Contact: </span>
                  <span className="text-sm text-gray-600">{alert.contact_info}</span>
                </div>
              )}

              {/* Attribution info */}
              <div className="flex items-center gap-4 text-sm text-gray-600 mt-3 pt-3 border-t border-gray-300">
                <div>
                  <span className="font-semibold">Posted: </span>
                  {new Date(alert.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                  })}
                </div>
                {alert.expires_at && (
                  <div>
                    <span className="font-semibold">Expires: </span>
                    {new Date(alert.expires_at).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </div>
                )}
              </div>

              {/* Show attribution */}
              <div className="text-sm text-gray-600 mt-2">
                {alert.on_behalf_of_name || alert.on_behalf_of_organization ? (
                  <>
                    <span className="font-semibold">Issued by: </span>
                    {alert.on_behalf_of_name}
                    {alert.on_behalf_of_organization && ` (${alert.on_behalf_of_organization})`}
                    {' '}via {alert.creator_name || alert.creator_email}
                  </>
                ) : (
                  <>
                    <span className="font-semibold">Issued by: </span>
                    {alert.creator_name || alert.creator_email}
                  </>
                )}
              </div>
            </div>
          </div>

          {/* Action buttons (only for authorized users) */}
          {canEditAlert(alert) && (
            <div className="flex gap-2">
              <button
                onClick={() => openEditForm(alert)}
                className="p-2 hover:bg-white/50 rounded-lg transition"
                title="Edit alert"
              >
                <Edit2 className="w-5 h-5 text-gray-700" />
              </button>
              {isArchived ? (
                <button
                  onClick={() => restoreAlert(alert.id)}
                  className="p-2 hover:bg-white/50 rounded-lg transition"
                  title="Restore alert"
                >
                  <Archive className="w-5 h-5 text-green-600" />
                </button>
              ) : (
                <button
                  onClick={() => archiveAlert(alert.id)}
                  className="p-2 hover:bg-white/50 rounded-lg transition"
                  title="Archive alert"
                >
                  <Archive className="w-5 h-5 text-gray-700" />
                </button>
              )}
            </div>
          )}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-green-50 to-white">
      <div className="max-w-6xl mx-auto px-4 py-8">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-4xl font-bold text-gabriola-green mb-2">Community Alerts</h1>
            <p className="text-gray-600">Stay informed about important updates and notices</p>
          </div>
          {canManageAlerts && (
            <button
              onClick={openNewForm}
              className="flex items-center gap-2 bg-gabriola-green text-white px-6 py-3 rounded-lg font-bold hover:bg-gabriola-green-dark transition shadow-lg"
            >
              <Plus className="w-5 h-5" />
              Create Alert
            </button>
          )}
        </div>

        {/* Toggle between active and archived */}
        <div className="flex gap-4 mb-6">
          <button
            onClick={() => setShowArchived(false)}
            className={`px-6 py-3 rounded-lg font-semibold transition ${
              !showArchived
                ? 'bg-gabriola-green text-white'
                : 'bg-white text-gray-700 hover:bg-gray-50'
            }`}
          >
            Active Alerts ({alerts.length})
          </button>
          {canManageAlerts && (
            <button
              onClick={() => setShowArchived(true)}
              className={`px-6 py-3 rounded-lg font-semibold transition ${
                showArchived
                  ? 'bg-gabriola-green text-white'
                  : 'bg-white text-gray-700 hover:bg-gray-50'
              }`}
            >
              Archived ({archivedAlerts.length})
            </button>
          )}
        </div>

        {/* Alerts list */}
        <div className="space-y-6">
          {loading ? (
            <div className="bg-white rounded-xl shadow-md p-12 text-center">
              <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gabriola-green mb-4"></div>
              <p className="text-gray-600">Loading alerts...</p>
            </div>
          ) : !showArchived ? (
            // Active alerts
            alerts.length === 0 ? (
              <div className="bg-white rounded-xl shadow-md p-12 text-center">
                <Bell className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <p className="text-xl text-gray-600">No active alerts at this time</p>
                <p className="text-gray-500 mt-2">Check back later for updates</p>
              </div>
            ) : (
              alerts.map(alert => renderAlert(alert, false))
            )
          ) : (
            // Archived alerts
            archivedAlerts.length === 0 ? (
              <div className="bg-white rounded-xl shadow-md p-12 text-center">
                <Archive className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <p className="text-xl text-gray-600">No archived alerts</p>
              </div>
            ) : (
              archivedAlerts.map(alert => renderAlert(alert, true))
            )
          )}
        </div>

        {/* Create/Edit Form Modal */}
        {showForm && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8 shadow-2xl">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-3xl font-bold text-gabriola-green">
                  {editingAlert ? 'Edit Alert' : 'Create New Alert'}
                </h2>
                <button
                  onClick={() => {
                    setShowForm(false);
                    setEditingAlert(null);
                  }}
                  className="p-2 hover:bg-gray-100 rounded-lg transition"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              <form onSubmit={createOrUpdate} className="space-y-4">
                {/* Title */}
                <div>
                  <label className="block text-sm font-medium mb-2">Alert Title *</label>
                  <input
                    type="text"
                    value={form.title}
                    onChange={(e) => setForm({ ...form, title: e.target.value })}
                    className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                    placeholder="e.g., Ferry Service Disruption"
                    required
                  />
                </div>

                {/* Message */}
                <div>
                  <label className="block text-sm font-medium mb-2">Message *</label>
                  <textarea
                    value={form.message}
                    onChange={(e) => setForm({ ...form, message: e.target.value })}
                    className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                    rows={4}
                    placeholder="Detailed information about the alert..."
                    required
                  />
                </div>

                {/* Severity */}
                <div>
                  <label className="block text-sm font-medium mb-2">Severity Level *</label>
                  <select
                    value={form.severity}
                    onChange={(e) => setForm({ ...form, severity: e.target.value as AlertSeverity })}
                    className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                  >
                    <option value="info">Info (Blue) - General information</option>
                    <option value="advisory">Advisory (Yellow) - Be aware</option>
                    <option value="warning">Warning (Orange) - Take action</option>
                    <option value="emergency">Emergency (Red) - Immediate action required</option>
                  </select>
                </div>

                {/* Attribution Notice */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <p className="text-sm text-blue-900">
                    <strong>üìù Attribution:</strong> This alert will be automatically attributed to you ({user?.full_name || user?.email}).
                    {' '}If you're issuing this on behalf of someone else or an organization, fill in the fields below.
                  </p>
                </div>

                {/* Two column layout - "On behalf of" fields */}
                <div className="grid grid-cols-2 gap-4">
                  {/* On behalf of name */}
                  <div>
                    <label className="block text-sm font-medium mb-2">
                      On Behalf Of - Name (Optional)
                    </label>
                    <input
                      type="text"
                      value={form.on_behalf_of_name}
                      onChange={(e) => setForm({ ...form, on_behalf_of_name: e.target.value })}
                      className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                      placeholder="e.g., Chief Mike Stevens"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Only fill if issuing for someone else
                    </p>
                  </div>

                  {/* On behalf of organization */}
                  <div>
                    <label className="block text-sm font-medium mb-2">
                      On Behalf Of - Organization (Optional)
                    </label>
                    <input
                      type="text"
                      value={form.on_behalf_of_organization}
                      onChange={(e) => setForm({ ...form, on_behalf_of_organization: e.target.value })}
                      className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                      placeholder="e.g., Fire Department"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Organization you're representing
                    </p>
                  </div>
                </div>

                {/* Affected areas */}
                <div>
                  <label className="block text-sm font-medium mb-2">Affected Areas (Optional)</label>
                  <input
                    type="text"
                    value={form.affected_areas}
                    onChange={(e) => setForm({ ...form, affected_areas: e.target.value })}
                    className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                    placeholder="e.g., North End, South End (comma separated)"
                  />
                </div>

                {/* Action required */}
                <div>
                  <label className="block text-sm font-medium mb-2">Action Required (Optional)</label>
                  <input
                    type="text"
                    value={form.action_required}
                    onChange={(e) => setForm({ ...form, action_required: e.target.value })}
                    className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                    placeholder="What should people do?"
                  />
                </div>

                {/* Contact info */}
                <div>
                  <label className="block text-sm font-medium mb-2">Contact Info (Optional)</label>
                  <input
                    type="text"
                    value={form.contact_info}
                    onChange={(e) => setForm({ ...form, contact_info: e.target.value })}
                    className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                    placeholder="Phone or email for more information"
                  />
                </div>

                {/* Expires in */}
                <div>
                  <label className="block text-sm font-medium mb-2">Expires In</label>
                  <select
                    value={form.expiresInHours}
                    onChange={(e) => setForm({ ...form, expiresInHours: Number(e.target.value) })}
                    className="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-gabriola-green"
                  >
                    <option value={6}>6 hours</option>
                    <option value={12}>12 hours</option>
                    <option value={24}>24 hours</option>
                    <option value={48}>2 days</option>
                    <option value={72}>3 days</option>
                    <option value={168}>1 week</option>
                  </select>
                </div>

                {/* Buttons */}
                <div className="flex gap-4 pt-4">
                  <button
                    type="submit"
                    className="flex-1 bg-gabriola-green text-white py-3 rounded-lg font-bold hover:bg-gabriola-green-dark transition"
                  >
                    {editingAlert ? 'Update Alert' : 'Create Alert'}
                  </button>
                  <button
                    type="button"
                    onClick={() => {
                      setShowForm(false);
                      setEditingAlert(null);
                    }}
                    className="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
