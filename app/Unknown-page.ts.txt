'use client';

import { useState, useEffect } from 'react';
import LandingPage from '@/components/LandingPage';
import Calendar from '@/components/Calendar';
import BBS from '@/components/BBS';
import Directory from '@/components/Directory';
import Ferry from '@/components/Ferry';
import EmergencyAlert from '@/components/EmergencyAlert';
import { 
  getMockEvents, 
  getMockDirectory, 
  getMockFerryStatus, 
  getMockPosts,
  addMockPost,
  getEmergencyAlert,
  dismissEmergencyAlert 
} from '@/lib/data';
import { Event, BBSPost, DirectoryListing, FerryStatus, EmergencyAlert as EmergencyAlertType } from '@/lib/types';
import { CalendarDays, MessageSquare, BookOpen, Anchor, AlertTriangle, Home } from 'lucide-react';
import { auth } from '@/lib/firebase';
import { onAuthStateChanged } from 'firebase/auth';

type Tab = 'landing' | 'calendar' | 'bbs' | 'directory' | 'ferry';

export default function HomePage() {
  const [activeTab, setActiveTab] = useState<Tab>('landing');
  const [events, setEvents] = useState<Event[]>([]);
  const [posts, setPosts] = useState<BBSPost[]>([]);
  const [listings, setListings] = useState<DirectoryListing[]>([]);
  const [ferryStatus, setFerryStatus] = useState<FerryStatus | null>(null);
  const [emergencyAlert, setEmergencyAlert] = useState<EmergencyAlertType | null>(null);
  const [user, setUser] = useState<any>(null);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    setEvents(getMockEvents());
    setPosts(getMockPosts());
    setListings(getMockDirectory());
    setFerryStatus(getMockFerryStatus());
    setEmergencyAlert(getEmergencyAlert());

    const eventInterval = setInterval(() => {
      setEvents(getMockEvents());
    }, 3600000);

    const alertInterval = setInterval(() => {
      setEmergencyAlert(getEmergencyAlert());
    }, 30000);

    return () => {
      clearInterval(eventInterval);
      clearInterval(alertInterval);
    };
  }, []);

  const handleAddEvent = (event: Omit<Event, 'id'>) => {
    const newEvent: Event = {
      ...event,
      id: `event-user-${Date.now()}`,
    };
    setEvents([...events, newEvent].sort((a, b) => a.date.getTime() - b.date.getTime()));
  };

  const handleNewPost = (post: Omit<BBSPost, 'id' | 'createdAt' | 'replies'>) => {
    const newPost = addMockPost(post);
    setPosts([newPost, ...posts]);
  });
  };

  const handleAddListing = (listing: Omit<DirectoryListing, 'id'>) => {
    const newListing: DirectoryListing = {
      ...listing,
      id: `dir-${Date.now()}`,
    };
    setListings([...listings, newListing]);
  };

  const handleRefreshFerry = async (): Promise<FerryStatus> => {
    const newStatus = getMockFerryStatus();
    setFerryStatus(newStatus);
    return newStatus;
  };

  const handleDismissAlert = () => {
    dismissEmergencyAlert();
    setEmergencyAlert(null);
  };

  const handleNavigateFromLanding = (tab: string) => {
    setActiveTab(tab as Tab);
  };

  const tabs = [
    { id: 'calendar' as Tab, label: 'Calendar', icon: CalendarDays },
    { id: 'bbs' as Tab, label: 'BBS', icon: MessageSquare },
    { id: 'directory' as Tab, label: 'Directory', icon: BookOpen },
    { id: 'ferry' as Tab, label: 'Ferry', icon: Anchor },
  ];

  if (activeTab === 'landing') {
    return <LandingPage onNavigate={handleNavigateFromLanding} />;
  }

  // ← THIS WAS MISSING — FIXED NOW
  return (
    <div className="flex flex-col h-screen bg-gabriola-sand/10">
      <header className="bg-gradient-to-r from-gabriola-green to-gabriola-green-light text-white shadow-lg relative">
        <div className="px-4 py-4 flex items-center justify-between">
          <button
            onClick={() => setActiveTab('landing')}
            className="flex items-center gap-3 hover:opacity-80 transition-opacity"
          >
            <Home className="w-6 h-6" />
            <div className="text-left">
              <h1 className="text-2xl md:text-3xl font-display font-bold">
                Gabriola Connects
              </h1>
              <p className="text-sm text-gabriola-sand opacity-90">
                Your Island Community Hub
              </p>
            </div>
          </button>

          {emergencyAlert && emergencyAlert.active && (
            <button
              onClick={() => setEmergencyAlert(emergencyAlert)}
              className="absolute top-3 right-3 bg-gabriola-alert text-white p-2 rounded-full shadow-lg hover:bg-red-700 transition-all emergency-pulse"
              title="Emergency Alert Active"
            >
              <AlertTriangle className="w-6 h-6" />
            </button>
          )}
        </div>
      </header>

      <main className="flex-1 overflow-auto">
        <div className="h-full">
          {activeTab === 'calendar' && <Calendar events={events} onAddEvent={handleAddEvent} />}
          {activeTab === 'bbs' && <BBS posts={posts as BBSPost[]} onNewPost={handleNewPost} />}
          {activeTab === 'directory' && (
            <Directory listings={listings} onAddListing={handleAddListing} />
          )}
          {activeTab === 'ferry' && ferryStatus && (
            <Ferry initialStatus={ferryStatus} onRefresh={handleRefreshFerry} />
          )}
        </div>
      </main>

      <nav className="bg-white border-t-2 border-gabriola-green/20 shadow-lg">
        <div className="flex justify-around items-center h-20 max-w-screen-xl mx-auto px-4">
          {tabs.map(tab => {
            const Icon = tab.icon;
            const isActive = activeTab === tab.id;
            
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-all ${
                  isActive 
                    ? 'text-gabriola-green' 
                    : 'text-gray-500 hover:text-gabriola-green-light'
                }`}
              >
                <div className={`p-2 rounded-xl transition-all ${
                  isActive ? 'bg-gabriola-green/10' : ''
                }`}>
                  <Icon className={`w-6 h-6 md:w-7 md:h-7 ${
                    isActive ? 'scale-110' : ''
                  }`} />
                </div>
                <span className={`text-xs md:text-sm mt-1 font-medium ${
                  isActive ? 'font-bold' : ''
                }`}>
                  {tab.label}
                </span>
              </button>
            );
          })}
        </div>
      </nav>

      <EmergencyAlert alert={emergencyAlert} onDismiss={handleDismissAlert} />
    </div>
  );
}