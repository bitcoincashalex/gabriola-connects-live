// app/page.tsx
// v3.1.1 - Fixed TypeScript error (created_at/updated_at as strings)
// Date: 2024-12-10
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import LandingPage from '@/components/LandingPage';
import Calendar from '@/components/Calendar';
import BBS from '@/components/BBS';
import Directory from '@/components/Directory';
import Ferry from '@/components/Ferry';
import EmergencyAlertBanner from '@/components/EmergencyAlertBanner';
import { useUser } from '@/components/AuthProvider';
import { Search, CalendarDays, MessageSquare, BookOpen, Anchor } from 'lucide-react';
import { supabase } from '@/lib/supabase';
import { Event } from '@/lib/types';

type Tab = 'landing' | 'calendar' | 'forum' | 'directory' | 'ferry' | 'search';

export default function HomePage() {
  const { user } = useUser();
  const router = useRouter();
  const [activeTab, setActiveTab] = useState<Tab>('landing');
  const [events, setEvents] = useState<Event[]>([]);
  const [eventsLoading, setEventsLoading] = useState(true);

  // Read URL hash on mount and when hash changes
  useEffect(() => {
    const readHashAndSetTab = () => {
      const hash = window.location.hash.slice(1); // Remove '#'
      if (hash && ['calendar', 'forum', 'directory', 'ferry', 'search'].includes(hash)) {
        setActiveTab(hash as Tab);
      } else {
        setActiveTab('landing');
      }
    };

    // Read initial hash
    readHashAndSetTab();

    // Listen for hash changes (back/forward button)
    window.addEventListener('hashchange', readHashAndSetTab);
    
    return () => {
      window.removeEventListener('hashchange', readHashAndSetTab);
    };
  }, []);

  // Fetch events when calendar tab is active
  useEffect(() => {
    if (activeTab === 'calendar') {
      fetchEvents();
    }
  }, [activeTab]);

  const fetchEvents = async () => {
    setEventsLoading(true);
    try {
      const { data, error } = await supabase
        .from('events')
        .select('*')
        .eq('is_approved', true)
        .order('start_date', { ascending: true });

      if (error) throw error;

      // Convert database rows to Event objects
      const formattedEvents: Event[] = (data || []).map(event => ({
        // Core
        id: event.id,
        title: event.title,
        description: event.description || '',
        category: event.category,
        
        // Date/Time
        start_date: new Date(event.start_date),
        end_date: event.end_date ? new Date(event.end_date) : new Date(event.start_date),
        start_time: event.start_time || undefined,
        end_time: event.end_time || undefined,
        is_all_day: event.is_all_day || false,
        
        // Recurrence
        is_recurring: event.is_recurring || false,
        recurrence_pattern: event.recurrence_pattern,
        
        // Location
        location: event.location || '',
        venue_name: event.venue_name,
        venue_address: event.venue_address,
        venue_city: event.venue_city,
        venue_postal_code: event.venue_postal_code,
        venue_map_url: event.venue_map_url,
        parking_info: event.parking_info,
        
        // Cost & Registration
        fees: event.fees,
        registration_url: event.registration_url,
        registration_required: event.registration_required,
        registration_deadline: event.registration_deadline,
        
        // Capacity
        max_attendees: event.max_attendees,
        min_attendees: event.min_attendees,
        rsvp_count: event.rsvp_count,
        waitlist_enabled: event.waitlist_enabled,
        waitlist_count: event.waitlist_count,
        
        // Organizer
        organizer_name: event.organizer_name,
        organizer_organization: event.organizer_organization,
        organizer_website: event.organizer_website,
        contact_email: event.contact_email,
        contact_phone: event.contact_phone,
        
        // Additional Info
        additional_info: event.additional_info,
        age_restrictions: event.age_restrictions,
        accessibility_info: event.accessibility_info,
        what_to_bring: event.what_to_bring,
        dress_code: event.dress_code,
        
        // Media
        image_url: event.image_url,
        
        // Metadata
        created_at: event.created_at || new Date().toISOString(),
        updated_at: event.updated_at || new Date().toISOString(),
        is_approved: event.is_approved,
        is_featured: event.is_featured || false,
        tags: event.tags || [],
      }));

      setEvents(formattedEvents);
    } catch (err) {
      console.error('Error fetching events:', err);
    } finally {
      setEventsLoading(false);
    }
  };

  const handleNavigateFromLanding = (tab: string) => {
    // Update URL hash (which triggers hashchange event and sets activeTab)
    window.location.hash = tab;
  };

  const handleTabClick = (tab: Tab) => {
    if (tab === 'landing') {
      // Clear hash for landing page
      window.location.hash = '';
    } else {
      // Set hash for other tabs
      window.location.hash = tab;
    }
  };

  // Build tabs array - hide forum for banned users
  const tabs = [
    { id: 'calendar' as Tab, label: 'Calendar', icon: CalendarDays },
    // Only show forum if user is not banned
    ...(user?.is_banned ? [] : [{ id: 'forum' as Tab, label: 'Forum', icon: MessageSquare }]),
    { id: 'directory' as Tab, label: 'Directory', icon: BookOpen },
    { id: 'search' as Tab, label: 'Search', icon: Search },
    { id: 'ferry' as Tab, label: 'Ferry', icon: Anchor },
  ];

  if (activeTab === 'landing') {
    return (
      <>
        <EmergencyAlertBanner />
        <LandingPage onNavigate={handleNavigateFromLanding} />
      </>
    );
  }

  return (
    <div className="flex flex-col min-h-screen bg-gabriola-sand/10">
      <EmergencyAlertBanner />
      <main className="flex-1 overflow-auto">
        {activeTab === 'calendar' && <Calendar events={events} loading={eventsLoading} />}
        {activeTab === 'forum' && <BBS />}
        {activeTab === 'directory' && <Directory />}
        {activeTab === 'ferry' && <Ferry />}
        {activeTab === 'search' && (
          <div className="max-w-2xl mx-auto px-6 py-20 text-center">
            <h1 className="text-4xl font-bold text-gabriola-green mb-12">Search Coming Soon</h1>
          </div>
        )}
      </main>

      <nav className="bg-white border-t-2 border-gabriola-green/20 shadow-lg">
        <div className="flex justify-around items-center h-20 max-w-screen-xl mx-auto px-4">
          {tabs.map(tab => {
            const Icon = tab.icon;
            const isActive = activeTab === tab.id;
            return (
              <button
                key={tab.id}
                onClick={() => handleTabClick(tab.id)}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-all ${
                  isActive ? 'text-gabriola-green' : 'text-gray-500 hover:text-gabriola-green-light'
                }`}
              >
                <div className={`p-2 rounded-xl transition-all ${isActive ? 'bg-gabriola-green/10' : ''}`}>
                  <Icon className={`w-6 h-6 md:w-7 md:h-7 ${isActive ? 'scale-110' : ''}`} />
                </div>
                <span className={`text-xs md:text-sm mt-1 font-medium ${isActive ? 'font-bold' : ''}`}>
                  {tab.label}
                </span>
              </button>
            );
          })}
        </div>
      </nav>
    </div>
  );
}
